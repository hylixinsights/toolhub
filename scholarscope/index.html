<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScholarScope — Analyze Scientific Impact</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.1.1/wordcloud2.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,300&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg-primary:#0f172a;--bg-secondary:#1e293b;--bg-tertiary:#334155;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--text-muted:#64748b;--accent:#38bdf8;--accent-dim:rgba(56,189,248,.15);--border:rgba(148,163,184,.08)}
        html.light{--bg-primary:#f8fafc;--bg-secondary:#fff;--bg-tertiary:#e2e8f0;--text-primary:#1e293b;--text-secondary:#475569;--text-muted:#94a3b8;--accent:#0284c7;--accent-dim:rgba(2,132,199,.1);--border:rgba(0,0,0,.06)}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'DM Sans',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;transition:background .4s,color .4s}
        .mono{font-family:'Space Mono',monospace}.tt{transition:background .4s,color .4s,border-color .4s,box-shadow .4s}
        #landing{display:flex;flex-direction:column;min-height:100vh}#results,#loading,#error,#disambig{display:none}
        header{display:flex;align-items:center;justify-content:space-between;padding:1.25rem 2rem;border-bottom:1px solid var(--border);background:var(--bg-primary);position:sticky;top:0;z-index:50}
        .logo{font-family:'Space Mono',monospace;font-size:1.15rem;font-weight:700;letter-spacing:-.02em;color:var(--text-primary)}.logo span{color:var(--accent)}
        #themeToggle{background:0 0;border:none;cursor:pointer;color:var(--text-muted);padding:.5rem;border-radius:.5rem;display:flex;align-items:center;justify-content:center;transition:color .3s,background .3s}
        #themeToggle:hover{color:var(--accent);background:var(--accent-dim)}#themeToggle svg{width:20px;height:20px}
        .hero{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2rem;text-align:center}
        .hero h1{font-size:clamp(1.75rem,4vw,2.75rem);font-weight:600;line-height:1.2;max-width:600px;margin-bottom:.5rem;letter-spacing:-.03em}
        .hero p{color:var(--text-secondary);font-size:1.05rem;margin-bottom:2.5rem;max-width:440px}
        .search-container{display:flex;width:100%;max-width:520px;background:var(--bg-secondary);border-radius:.75rem;overflow:hidden;border:1px solid var(--border);transition:box-shadow .3s,border-color .3s}
        .search-container:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim)}
        #searchInput{flex:1;padding:.9rem 1.2rem;background:0 0;border:none;outline:none;color:var(--text-primary);font-size:.95rem;font-family:'DM Sans',sans-serif}
        #searchInput::placeholder{color:var(--text-muted)}
        #searchBtn{padding:.9rem 1.5rem;background:var(--accent);color:#0f172a;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:600;font-size:.9rem;letter-spacing:.02em;transition:opacity .2s}
        #searchBtn:hover{opacity:.85}#searchBtn:disabled{opacity:.5;cursor:not-allowed}
        .example-link{margin-top:1rem;font-size:.82rem;color:var(--text-muted);opacity:.6;cursor:pointer;transition:opacity .2s}
        .example-link:hover{opacity:1;color:var(--accent)}.example-link span{text-decoration:underline}
        #loading{flex-direction:column;align-items:center;justify-content:center;padding:4rem 2rem;text-align:center;min-height:60vh}
        .spinner{width:36px;height:36px;border:3px solid var(--bg-tertiary);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin-bottom:1rem}
        @keyframes spin{to{transform:rotate(360deg)}}#loadingText{color:var(--text-secondary);font-size:.9rem}
        #error{text-align:center;padding:3rem 2rem;min-height:40vh;flex-direction:column;align-items:center;justify-content:center}
        #error .error-icon{font-size:2rem;margin-bottom:.75rem;display:block}
        #errorMsg{color:var(--text-secondary);font-size:.95rem;max-width:400px}
        #error button{margin-top:1rem;padding:.6rem 1.5rem;background:var(--accent-dim);color:var(--accent);border:1px solid var(--accent);border-radius:.5rem;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.85rem;transition:background .2s}
        #error button:hover{background:var(--accent);color:#0f172a}
        #disambig{padding:2rem;max-width:700px;margin:0 auto;min-height:60vh}
        #disambig h2{font-size:1.2rem;font-weight:600;margin-bottom:.5rem}
        #disambig .subtitle{color:var(--text-secondary);font-size:.9rem;margin-bottom:1.5rem}
        .author-option{background:var(--bg-secondary);border:1px solid var(--border);border-radius:.75rem;padding:1.2rem 1.5rem;margin-bottom:.75rem;cursor:pointer;transition:border-color .2s,box-shadow .2s;display:flex;justify-content:space-between;align-items:center}
        .author-option:hover{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-dim)}
        .author-option .ao-name{font-weight:600;font-size:1rem;margin-bottom:.2rem}
        .author-option .ao-meta{color:var(--text-muted);font-size:.8rem;font-family:'Space Mono',monospace}
        .author-option .ao-arrow{color:var(--text-muted);font-size:1.2rem}
        .dback{display:inline-flex;align-items:center;gap:.4rem;color:var(--text-muted);font-size:.85rem;cursor:pointer;padding:.5rem 0;margin-bottom:1.5rem;background:0 0;border:none;font-family:'DM Sans',sans-serif;transition:color .2s}
        .dback:hover{color:var(--accent)}.dback svg{width:16px;height:16px}
        .dashboard{max-width:1200px;margin:0 auto;padding:2rem 1.5rem 4rem}
        .profile-card{background:var(--bg-secondary);border-radius:1rem;padding:2rem;margin-bottom:2rem;border:1px solid var(--border)}
        .profile-name{font-size:1.6rem;font-weight:700;letter-spacing:-.02em;margin-bottom:.25rem}
        .profile-id{color:var(--text-muted);font-size:.8rem;margin-bottom:1.25rem}.profile-id a{color:var(--accent);text-decoration:none}.profile-id a:hover{text-decoration:underline}
        .stats-row{display:flex;gap:2.5rem;flex-wrap:wrap}
        .stat-item{display:flex;flex-direction:column}
        .stat-value{font-family:'Space Mono',monospace;font-size:1.5rem;font-weight:700;color:var(--accent)}
        .stat-label{font-size:.78rem;color:var(--text-muted);margin-top:.15rem;letter-spacing:.04em;text-transform:uppercase}
        .chart-panel{background:var(--bg-secondary);border-radius:1rem;padding:1.5rem;margin-bottom:1.5rem;border:1px solid var(--border)}
        .chart-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:.75rem}
        .chart-title{font-size:.95rem;font-weight:600;letter-spacing:-.01em}
        .chart-control select{background:var(--bg-tertiary);color:var(--text-secondary);border:1px solid var(--border);border-radius:.4rem;padding:.35rem .6rem;font-size:.78rem;font-family:'DM Sans',sans-serif;cursor:pointer;outline:none;transition:border-color .2s}
        .chart-control select:focus{border-color:var(--accent)}
        .chart-box{width:100%;height:380px}.chart-box-wc{width:100%;height:420px;min-height:300px;position:relative}#wordcloudCanvas{display:block}
        .chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem}@media(max-width:820px){.chart-grid{grid-template-columns:1fr}}
        .back-btn{display:inline-flex;align-items:center;gap:.4rem;color:var(--text-muted);font-size:.85rem;cursor:pointer;padding:.5rem 0;margin-bottom:1rem;background:0 0;border:none;font-family:'DM Sans',sans-serif;transition:color .2s}
        .back-btn:hover{color:var(--accent)}.back-btn svg{width:16px;height:16px}
        footer{text-align:center;padding:1.5rem;color:var(--text-muted);font-size:.75rem;border-top:1px solid var(--border)}footer a{color:var(--accent);text-decoration:none}
        ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:0 0}::-webkit-scrollbar-thumb{background:var(--bg-tertiary);border-radius:3px}
        @keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
        .fade-up{animation:fadeUp .5s ease forwards}.fade-up-1{animation-delay:.05s;opacity:0}.fade-up-2{animation-delay:.15s;opacity:0}.fade-up-3{animation-delay:.25s;opacity:0}.fade-up-4{animation-delay:.35s;opacity:0}
    </style>
</head>
<body>
    <header class="tt">
        <div class="logo">Scholar<span>Scope</span></div>
        <button id="themeToggle" aria-label="Toggle theme">
            <svg id="iconMoon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0112.478 3.09a9.72 9.72 0 109.274 11.912z"/></svg>
            <svg id="iconSun" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="display:none;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m8.485-9.485h-1M4.515 12h-1m14.95-5.95l-.707.707M6.343 17.657l-.707.707m12.02 0l-.707-.707M6.343 6.343l-.707-.707M12 7a5 5 0 100 10 5 5 0 000-10z"/></svg>
        </button>
    </header>
    <div id="landing"><div class="hero">
        <h1>Analyze scientific impact beyond basic metrics</h1>
        <p>Explore publication patterns, citation timelines, and research focus from Semantic Scholar data.</p>
        <div class="search-container tt"><input type="text" id="searchInput" placeholder="Enter researcher name…" autocomplete="off"><button id="searchBtn">Analyze</button></div>
        <div class="example-link" id="exampleLink">Or see an example: <span>Helder Nakaya</span></div>
    </div></div>
    <div id="loading"><div class="spinner"></div><div id="loadingText">Searching Semantic Scholar…</div></div>
    <div id="error"><span class="error-icon">⚠</span><div id="errorMsg"></div><button id="errorBack">Go back</button></div>
    <div id="disambig">
        <button class="dback" id="disambigBack"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>Back to search</button>
        <h2>Multiple authors found</h2>
        <div class="subtitle">Select the correct researcher profile:</div>
        <div id="authorList"></div>
    </div>
    <div id="results"><div class="dashboard">
        <button class="back-btn" id="backBtn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>New search</button>
        <div class="profile-card tt fade-up fade-up-1" id="profileCard"></div>
        <div class="chart-grid">
            <div class="chart-panel tt fade-up fade-up-2"><div class="chart-header"><div class="chart-title">Citation Timeline</div></div><div class="chart-box" id="timelineChart"></div></div>
            <div class="chart-panel tt fade-up fade-up-3"><div class="chart-header"><div class="chart-title">Top Venues</div><div class="chart-control"><select id="venueLimit"><option value="5">Top 5</option><option value="10" selected>Top 10</option><option value="20">Top 20</option></select></div></div><div class="chart-box" id="venueChart"></div></div>
        </div>
        <div class="chart-panel tt fade-up fade-up-3" style="animation-delay:.2s">
            <div class="chart-header">
                <div class="chart-title">Paper Impact × Publication Year</div>
                <div class="chart-control">
                    <select id="scatterMode">
                        <option value="abs">Absolute citations</option>
                        <option value="norm">Normalized (citations / year)</option>
                    </select>
                </div>
            </div>
            <div class="chart-box" id="scatterChart"></div>
            <div style="color:var(--text-muted);font-size:.72rem;margin-top:.5rem;line-height:1.4">
                <span id="scatterFormula"></span>
            </div>
        </div>
        <div class="chart-panel tt fade-up fade-up-4"><div class="chart-header"><div class="chart-title">Research Focus — Weighted by Influential Citations</div><div class="chart-control"><select id="wcLimit"><option value="30">Top 30 terms</option><option value="50" selected>Top 50 terms</option><option value="100">Top 100 terms</option></select></div></div><div class="chart-box-wc"><canvas id="wordcloudCanvas"></canvas></div></div>
    </div></div>
    <footer class="tt">Data sourced from <a href="https://www.semanticscholar.org/" target="_blank" rel="noopener">Semantic Scholar</a> API. ScholarScope is an independent visualization tool.</footer>

<script>
const API='https://api.semanticscholar.org/graph/v1';
let appState={author:null,papers:[],venueData:{},timelineData:{},wordFreq:[]};
const $=id=>document.getElementById(id);
const VIEWS=['landing','loading','error','disambig','results'];
function showView(v){VIEWS.forEach(id=>{const el=$(id);el.style.display=id===v?(id==='landing'||id==='loading'?'flex':'block'):'none'})}

// Theme
(function(){if(localStorage.getItem('ss-theme')==='light')document.documentElement.classList.replace('dark','light');uI()})();
$('themeToggle').addEventListener('click',()=>{const h=document.documentElement;h.classList.toggle('dark');h.classList.toggle('light');localStorage.setItem('ss-theme',h.classList.contains('light')?'light':'dark');uI();if($('results').style.display==='block'){renderTimeline();renderVenues();renderScatter();renderWordcloud()}});
function uI(){const l=document.documentElement.classList.contains('light');$('iconMoon').style.display=l?'block':'none';$('iconSun').style.display=l?'none':'block'}
function isDark(){return document.documentElement.classList.contains('dark')}

// Nav
$('backBtn').addEventListener('click',()=>{showView('landing');$('searchInput').value='';$('searchInput').focus()});
$('errorBack').addEventListener('click',()=>{showView('landing');$('searchInput').focus()});
$('disambigBack').addEventListener('click',()=>{showView('landing');$('searchInput').focus()});

// Search
$('searchBtn').addEventListener('click',()=>doSearch($('searchInput').value.trim()));
$('searchInput').addEventListener('keydown',e=>{if(e.key==='Enter')doSearch($('searchInput').value.trim())});

// Example: bypass search, use known correct author ID directly
$('exampleLink').addEventListener('click',()=>{
    $('searchInput').value='Helder Nakaya';
    loadAuthorById('3493481');
});

async function doSearch(q){
    if(!q)return;
    $('searchBtn').disabled=true;
    showView('loading');
    $('loadingText').textContent='Searching Semantic Scholar…';
    try{
        const r=await fetch(`${API}/author/search?query=${encodeURIComponent(q)}&limit=10&fields=authorId,name,hIndex,paperCount`);
        if(!r.ok)throw new Error(`Search failed (HTTP ${r.status}). The API may be rate-limited — try again shortly.`);
        const d=await r.json();
        if(!d.data||d.data.length===0)throw new Error('No author found. Try a different name or spelling.');
        const cands=d.data.filter(a=>(a.paperCount||0)>0);
        if(cands.length===0)throw new Error('No author with publications found.');
        // Sort by h-index then paperCount
        cands.sort((a,b)=>(b.hIndex||0)-(a.hIndex||0)||(b.paperCount||0)-(a.paperCount||0));
        if(cands.length===1){
            await loadAuthorById(cands[0].authorId,cands[0]);
        } else {
            // Auto-select if top is clearly dominant
            const t=cands[0],s=cands[1];
            if((t.hIndex||0)>2*Math.max(s.hIndex||0,1)&&(t.paperCount||0)>20){
                await loadAuthorById(t.authorId,t);
            } else {
                showDisambig(cands);
            }
        }
    }catch(e){$('errorMsg').textContent=e.message;showView('error')}
    finally{$('searchBtn').disabled=false}
}

function showDisambig(authors){
    const list=$('authorList');list.innerHTML='';
    authors.forEach(a=>{
        const d=document.createElement('div');d.className='author-option tt';
        d.innerHTML=`<div><div class="ao-name">${esc(a.name)}</div><div class="ao-meta">h-index: ${a.hIndex??'?'} · ${a.paperCount??'?'} papers · ID: ${a.authorId}</div></div><div class="ao-arrow">→</div>`;
        d.addEventListener('click',()=>loadAuthorById(a.authorId,a));
        list.appendChild(d);
    });
    showView('disambig');
}

async function loadAuthorById(authorId,meta){
    showView('loading');
    $('loadingText').textContent='Fetching author profile…';
    try{
        if(!meta||meta.hIndex==null){
            const r=await fetch(`${API}/author/${authorId}?fields=authorId,name,hIndex,paperCount`);
            if(!r.ok)throw new Error(`Author fetch failed (HTTP ${r.status})`);
            meta=await r.json();
        }
        appState.author=meta;
        // Paginated paper fetch
        const all=[];const PG=500;let off=0;const tot=meta.paperCount||9999;
        while(off<tot){
            $('loadingText').textContent=`Fetching publications… (${all.length}${tot<9999?' / ~'+tot:''})`;
            const r=await fetch(`${API}/author/${authorId}/papers?fields=title,venue,year,citationCount,influentialCitationCount&offset=${off}&limit=${PG}`);
            if(!r.ok)throw new Error(`Papers fetch failed (HTTP ${r.status})`);
            const d=await r.json();const b=d.data||[];
            if(b.length===0)break;
            all.push(...b);off+=b.length;
            if(b.length<PG)break;
            await new Promise(r=>setTimeout(r,400));
        }
        $('loadingText').textContent=`Processing ${all.length} publications…`;
        appState.papers=all;
        processData();renderResults();showView('results');
    }catch(e){$('errorMsg').textContent=e.message;showView('error')}
}

// Stop words
const SW=new Set('a an the and or but in on at to for of with by from as is was are were be been being have has had do does did will would shall should may might can could not no nor so if then than that this these those it its we our they their them he she his her i me my you your all each every both few more most other some such only own same too very just about above after again against below between during into through before under over out up down off once here there when where why how what which who whom while also using based via new study analysis approach method methods results effect effects role case use among two one three four five non pre post vs de la el en les des di le et du une der von und den das die review model data research paper journal associated novel high low type human patients cells cell gene genes expression protein level levels studies clinical reveals reveal identify identification response responses immune system systems biology biological molecular'.split(' '));

function processData(){
    const P=appState.papers;
    // Venues
    const vm={};P.forEach(p=>{const v=(p.venue||'').trim();if(v)vm[v]=(vm[v]||0)+1});appState.venueData=vm;
    // Timeline
    const tm={};P.forEach(p=>{if(p.year)tm[p.year]=(tm[p.year]||0)+(p.citationCount||0)});appState.timelineData=tm;
    // Word cloud
    const ww={};
    P.forEach(p=>{
        const ic=p.influentialCitationCount||0;if(ic===0)return;
        (p.title||'').toLowerCase().replace(/[^a-z0-9\s\-]/g,' ').split(/\s+/).filter(w=>w.length>2&&!SW.has(w)).forEach(w=>{ww[w]=(ww[w]||0)+ic});
    });
    appState.wordFreq=Object.entries(ww).sort((a,b)=>b[1]-a[1]);
}

function renderResults(){
    const a=appState.author;
    const tc=appState.papers.reduce((s,p)=>s+(p.citationCount||0),0);
    const ti=appState.papers.reduce((s,p)=>s+(p.influentialCitationCount||0),0);
    $('profileCard').innerHTML=`
        <div class="profile-name">${esc(a.name)}</div>
        <div class="profile-id mono">ID: ${a.authorId} · <a href="https://www.semanticscholar.org/author/${a.authorId}" target="_blank" rel="noopener">View on Semantic Scholar ↗</a></div>
        <div class="stats-row">
            <div class="stat-item"><div class="stat-value">${fmt(a.hIndex)}</div><div class="stat-label">h-index</div></div>
            <div class="stat-item"><div class="stat-value">${fmt(appState.papers.length)}</div><div class="stat-label">Publications loaded</div></div>
            <div class="stat-item"><div class="stat-value">${fmt(tc)}</div><div class="stat-label">Total Citations</div></div>
            <div class="stat-item"><div class="stat-value">${fmt(ti)}</div><div class="stat-label">Influential Citations</div></div>
        </div>`;
    renderTimeline();renderVenues();renderScatter();renderWordcloud();
}

function cT(){const d=isDark();return{text:d?'#94a3b8':'#64748b',line:d?'#38bdf8':'#0284c7',bar:d?'#818cf8':'#6366f1',grid:d?'rgba(148,163,184,.08)':'rgba(0,0,0,.06)',ttBg:d?'#1e293b':'#fff',ttB:d?'#334155':'#e2e8f0',ttT:d?'#f1f5f9':'#1e293b',aS:d?'rgba(56,189,248,.25)':'rgba(2,132,199,.18)',aE:'rgba(56,189,248,0)',scatter:d?'rgba(129,140,248,0.7)':'rgba(99,102,241,0.65)',scatterBord:d?'#a5b4fc':'#818cf8'}}

let tlI=null;
function renderTimeline(){
    const d=appState.timelineData,yrs=Object.keys(d).map(Number).sort((a,b)=>a-b),v=yrs.map(y=>d[y]),t=cT();
    if(tlI)tlI.dispose();tlI=echarts.init($('timelineChart'));
    tlI.setOption({tooltip:{trigger:'axis',backgroundColor:t.ttBg,borderColor:t.ttB,textStyle:{color:t.ttT,fontFamily:'DM Sans',fontSize:13},formatter:p=>`<strong>${p[0].name}</strong><br/>Citations: ${fmt(p[0].value)}`},grid:{left:55,right:20,top:20,bottom:35},xAxis:{type:'category',data:yrs.map(String),axisLine:{lineStyle:{color:t.grid}},axisLabel:{color:t.text,fontSize:11,fontFamily:'Space Mono'},axisTick:{show:false}},yAxis:{type:'value',splitLine:{lineStyle:{color:t.grid}},axisLabel:{color:t.text,fontSize:11,fontFamily:'Space Mono',formatter:v=>v>=1000?(v/1000).toFixed(0)+'k':v},axisLine:{show:false},axisTick:{show:false}},series:[{type:'line',data:v,smooth:.3,symbolSize:5,symbol:'circle',lineStyle:{color:t.line,width:2.5},itemStyle:{color:t.line},areaStyle:{color:new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:t.aS},{offset:1,color:t.aE}])}}]});
    window.addEventListener('resize',()=>tlI&&tlI.resize());
}

let vnI=null;
$('venueLimit').addEventListener('change',renderVenues);
function renderVenues(){
    const lim=parseInt($('venueLimit').value)||10,entries=Object.entries(appState.venueData).sort((a,b)=>b[1]-a[1]).slice(0,lim).reverse();
    const names=entries.map(e=>e[0].length>40?e[0].slice(0,38)+'…':e[0]),full=entries.map(e=>e[0]),vals=entries.map(e=>e[1]),t=cT();
    if(vnI)vnI.dispose();vnI=echarts.init($('venueChart'));
    vnI.setOption({tooltip:{trigger:'axis',axisPointer:{type:'shadow'},backgroundColor:t.ttBg,borderColor:t.ttB,textStyle:{color:t.ttT,fontFamily:'DM Sans',fontSize:13},formatter:p=>`<strong>${full[p[0].dataIndex]}</strong><br/>Papers: ${p[0].value}`},grid:{left:180,right:30,top:10,bottom:25},xAxis:{type:'value',splitLine:{lineStyle:{color:t.grid}},axisLabel:{color:t.text,fontSize:11,fontFamily:'Space Mono'},axisLine:{show:false},axisTick:{show:false}},yAxis:{type:'category',data:names,axisLine:{lineStyle:{color:t.grid}},axisLabel:{color:t.text,fontSize:11,fontFamily:'DM Sans',width:170,overflow:'truncate'},axisTick:{show:false}},series:[{type:'bar',data:vals,barMaxWidth:22,itemStyle:{color:new echarts.graphic.LinearGradient(0,0,1,0,[{offset:0,color:t.bar},{offset:1,color:t.line}]),borderRadius:[0,4,4,0]}}]});
    window.addEventListener('resize',()=>vnI&&vnI.resize());
}

// ---------- Scatter: Paper Impact x Year ----------
let scI=null;
$('scatterMode').addEventListener('change',renderScatter);
function renderScatter(){
    const mode=$('scatterMode').value;
    const currentYear=new Date().getFullYear();
    const t=cT();
    const points=[];
    appState.papers.forEach(p=>{
        if(!p.year||p.year<1900)return;
        const cit=p.citationCount||0;
        const age=Math.max(1,currentYear-p.year+1);
        const yVal=mode==='norm'?parseFloat((cit/age).toFixed(2)):cit;
        points.push([p.year,yVal,cit,age,(p.title||'Untitled')]);
    });
    const fEl=$('scatterFormula');
    if(mode==='norm'){
        fEl.textContent='Normalized = Citations \u00f7 ('+currentYear+' \u2212 Publication Year + 1). Adjusts for older papers accumulating more citations over time.';
    } else {
        fEl.textContent='Showing raw citation count per paper. Switch to \u201cNormalized\u201d to adjust for publication age.';
    }
    if(scI)scI.dispose();
    scI=echarts.init($('scatterChart'));
    scI.setOption({
        tooltip:{trigger:'item',backgroundColor:t.ttBg,borderColor:t.ttB,textStyle:{color:t.ttT,fontFamily:'DM Sans',fontSize:12},
            formatter:function(p){var d=p.data;var tit=d[4].length>70?d[4].slice(0,68)+'\u2026':d[4];
                return '<strong style="display:block;max-width:280px;white-space:normal;line-height:1.3">'+esc(tit)+'</strong><br/>Year: '+d[0]+'<br/>Citations: '+fmt(d[2])+'<br/>Age: '+d[3]+' yr'+(d[3]>1?'s':'')+(mode==='norm'?'<br/>Normalized: '+d[1].toFixed(1)+' cit/yr':'');}},
        grid:{left:60,right:25,top:20,bottom:40},
        xAxis:{type:'value',name:'Year',nameLocation:'center',nameGap:28,nameTextStyle:{color:t.text,fontSize:11,fontFamily:'DM Sans'},
            min:function(v){return Math.max(1980,v.min-1)},max:function(v){return v.max+1},
            axisLine:{lineStyle:{color:t.grid}},axisLabel:{color:t.text,fontSize:11,fontFamily:'Space Mono',formatter:function(v){return Math.round(v).toString()}},axisTick:{show:false},splitLine:{show:false}},
        yAxis:{type:'value',name:mode==='norm'?'Citations / Year':'Citations',nameLocation:'center',nameGap:45,nameTextStyle:{color:t.text,fontSize:11,fontFamily:'DM Sans'},
            splitLine:{lineStyle:{color:t.grid}},axisLabel:{color:t.text,fontSize:11,fontFamily:'Space Mono',formatter:function(v){return v>=1000?(v/1000).toFixed(1)+'k':Math.round(v).toString()}},axisLine:{show:false},axisTick:{show:false}},
        series:[{type:'scatter',data:points,
            symbolSize:function(d){var c=d[2]||1;return Math.max(4,Math.min(28,3+Math.log(c+1)*2.5))},
            itemStyle:{color:isDark()?'rgba(129,140,248,0.7)':'rgba(99,102,241,0.65)',borderColor:isDark()?'#a5b4fc':'#818cf8',borderWidth:1},
            emphasis:{itemStyle:{color:t.line,borderColor:'#fff',borderWidth:2,shadowBlur:8,shadowColor:'rgba(56,189,248,0.4)'},scale:1.8}}]
    });
    window.addEventListener('resize',()=>scI&&scI.resize());
}

$('wcLimit').addEventListener('change',renderWordcloud);
let wcTimer=null;
function renderWordcloud(){
    // Delay to ensure container is laid out
    if(wcTimer)clearTimeout(wcTimer);
    wcTimer=setTimeout(_doWordcloud,300);
}
function _doWordcloud(){
    const lim=parseInt($('wcLimit').value)||50,data=appState.wordFreq.slice(0,lim);
    if(!data.length){$('wordcloudCanvas').parentElement.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-muted);font-size:0.9rem;">No influential citation data available for word cloud.</div>';return}
    const ct=$('wordcloudCanvas').parentElement;
    const w=ct.clientWidth||ct.offsetWidth||600;
    const h=ct.clientHeight||ct.offsetHeight||400;
    // Recreate canvas to avoid stale state
    ct.innerHTML='<canvas id="wordcloudCanvas" width="'+w+'" height="'+h+'" style="width:'+w+'px;height:'+h+'px;display:block;"></canvas>';
    const c=$('wordcloudCanvas');
    // Clear
    const ctx=c.getContext('2d');ctx.clearRect(0,0,w,h);
    const mx=data[0][1],d=isDark();
    const cols=d?['#38bdf8','#818cf8','#a78bfa','#67e8f9','#34d399','#f472b6','#fbbf24']:['#0284c7','#6366f1','#7c3aed','#0891b2','#059669','#db2777','#d97706'];
    // Scale: largest word fills ~5% of canvas width
    const maxFontSize=Math.max(48,Math.min(80,w*0.08));
    const minFontSize=Math.max(10,maxFontSize*0.18);
    const list=data.map(([word,wt])=>[word,Math.max(minFontSize,Math.round((wt/mx)*maxFontSize))]);
    try{
        WordCloud(c,{list:list,gridSize:Math.max(4,Math.round(w/150)),weightFactor:1,fontFamily:'DM Sans,sans-serif',fontWeight:600,color:()=>cols[Math.floor(Math.random()*cols.length)],backgroundColor:'transparent',rotateRatio:0.2,rotationSteps:2,shuffle:true,drawOutOfBound:false,shrinkToFit:true});
    }catch(e){console.warn('WordCloud error:',e)}
}

function fmt(n){return n==null?'—':Number(n).toLocaleString('en-US')}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

showView('landing');$('searchInput').focus();
</script>
</body>
</html>
