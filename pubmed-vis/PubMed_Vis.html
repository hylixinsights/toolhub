<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PubMed Network Visualizer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(-45deg, #0f172a, #1e3a8a, #1e40af, #0c4a6e, #172554, #1e3a8a);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
            min-height: 100vh;
            padding: 20px;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        header {
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #1e40af 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
        h1 { font-size: 2.8em; margin-bottom: 12px; text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3); }
        .subtitle { font-size: 1.15em; opacity: 0.95; }
        .developer-credit { margin-top: 18px; font-size: 0.95em; opacity: 0.9; }
        .developer-credit a { color: #60a5fa; text-decoration: none; font-weight: 600; transition: all 0.3s; }
        .developer-credit a:hover { color: #93c5fd; text-decoration: underline; }
        .main-content { padding: 30px; }
        .upload-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #dbeafe 50%, #bfdbfe 100%);
            border: 3px dashed #1e40af;
            border-radius: 15px;
            padding: 45px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.4s;
        }
        .upload-section:hover { border-color: #1e3a8a; transform: translateY(-5px); box-shadow: 0 15px 35px rgba(30, 64, 175, 0.25); }
        .upload-section.dragover { background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%); border-color: #1e3a8a; }
        #fileInput { display: none; }
        .upload-btn {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            border: none;
            padding: 16px 45px;
            font-size: 1.15em;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(30, 64, 175, 0.3);
        }
        .upload-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(30, 64, 175, 0.4); }
        .upload-icon { font-size: 3.5em; margin-bottom: 15px; }
        .network-tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 3px solid #e2e8f0; }
        .tab {
            padding: 16px 35px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.15em;
            border-bottom: 4px solid transparent;
            transition: all 0.3s;
            color: #64748b;
            font-weight: 500;
        }
        .tab:hover { color: #1e40af; }
        .tab.active { color: #1e40af; border-bottom-color: #1e40af; font-weight: 700; }
        .network-container { display: none; }
        .network-container.active { display: block; }
        .controls {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 22px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            align-items: center;
            border: 2px solid #e2e8f0;
        }
        .control-group { display: flex; align-items: center; gap: 12px; }
        .control-group label { font-weight: 600; color: #1e293b; }
        .search-container {
            position: relative;
            flex-grow: 1;
            max-width: 400px;
        }
        .search-input {
            width: 100%;
            padding: 10px 40px 10px 16px;
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            transition: border-color 0.3s;
        }
        .search-input:focus {
            outline: none;
            border-color: #1e40af;
        }
        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            pointer-events: none;
        }
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #1e40af;
            border-radius: 8px;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            display: none;
        }
        .search-results.show { display: block; }
        .search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #e2e8f0;
            transition: background 0.2s;
        }
        .search-result-item:hover {
            background: #f0f9ff;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        .no-results {
            padding: 20px;
            text-align: center;
            color: #94a3b8;
        }
        select, input[type="range"] { padding: 9px 16px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1em; background: white; }
        select:focus { outline: none; border-color: #1e40af; }
        input[type="range"] { width: 160px; accent-color: #1e40af; }
        .btn { padding: 11px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; transition: all 0.3s; font-weight: 600; }
        .btn-primary { background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(30, 64, 175, 0.3); }
        .btn-secondary { background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); color: white; }
        .btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(15, 118, 110, 0.3); }
        .btn-clear { background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); color: white; }
        .btn-clear:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(220, 38, 38, 0.3); }
        .svg-container { width: 100%; height: 600px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; overflow: hidden; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }
        .stat-card {
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #1e40af 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            transition: all 0.4s;
        }
        .stat-card:hover { transform: translateY(-8px); }
        .stat-value { font-size: 2.8em; font-weight: bold; margin-bottom: 8px; }
        .stat-label { font-size: 0.95em; opacity: 0.95; }
        .tooltip {
            position: absolute;
            background: white;
            border: 2px solid #1e40af;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            max-width: 280px;
        }
        .tooltip.show { opacity: 1; }
        .tooltip a { color: #1e40af; text-decoration: none; font-weight: 600; }
        .tooltip a:hover { text-decoration: underline; }
        .loading { display: none; text-align: center; padding: 50px; }
        .loading.active { display: block; }
        .spinner {
            border: 5px solid #f3f4f6;
            border-top: 5px solid #1e40af;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error { background: #fee2e2; color: #991b1b; padding: 18px; border-radius: 10px; margin-bottom: 20px; display: none; border-left: 5px solid #dc2626; }
        .error.active { display: block; }
        .legend { background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 18px; margin-top: 25px; }
        .legend-title { font-weight: 700; margin-bottom: 12px; color: #0f172a; }
        .legend-item { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .legend-color { width: 22px; height: 22px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15); }
        svg text { font-family: 'Segoe UI', sans-serif; pointer-events: none; text-anchor: middle; dominant-baseline: central; }
        .node { cursor: pointer; stroke: white; stroke-width: 2.5px; transition: opacity 0.2s, stroke-width 0.2s; }
        .node.highlighted { stroke-width: 4px; stroke: #fbbf24; }
        .node.faded { opacity: 0.15; }
        .link { stroke: #94a3b8; stroke-opacity: 0.6; transition: opacity 0.2s, stroke-width 0.2s; }
        .link.highlighted { stroke: #fbbf24; stroke-width: 3px; stroke-opacity: 1; }
        .link.faded { opacity: 0.05; }
        svg text.faded { opacity: 0.15; }
        svg text.highlighted { font-weight: bold; }
        footer { background: #f8fafc; padding: 25px; text-align: center; color: #64748b; font-size: 0.95em; border-top: 2px solid #e2e8f0; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üî¨ PubMed Network Visualizer</h1>
            <p class="subtitle">Visualize paper-MeSH and co-authorship networks from your publications</p>
            <p class="developer-credit">Developed by Helder Nakaya (<a href="https://csbiology.org" target="_blank">CSBL</a>)</p>
        </header>
        <div class="main-content">
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">üìÅ</div>
                <h2>Upload Your PubMed Data</h2>
                <p style="margin: 15px 0; color: #475569;">Drag and drop your PubMed text file here, or click to browse</p>
                <input type="file" id="fileInput" accept=".txt" />
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Choose File</button>
                <p style="margin-top: 20px; font-size: 0.9em; color: #94a3b8;">Supports PubMed format (.txt) files</p>
            </div>
            <div class="error" id="errorMsg"></div>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing your data and generating networks...</p>
            </div>
            <div id="networkSection" style="display: none;">
                <div class="network-tabs">
                    <button class="tab active" onclick="switchNetwork('paper-mesh')">üìä Paper-MeSH Network</button>
                    <button class="tab" onclick="switchNetwork('coauthorship')">üë• Co-authorship Network</button>
                </div>
                <div id="paper-mesh" class="network-container active">
                    <div class="controls">
                        <div class="search-container">
                            <input type="text" class="search-input" id="searchPaperMesh" placeholder="üîç Search nodes..." />
                            <span class="search-icon">üîç</span>
                            <div class="search-results" id="searchResultsPaperMesh"></div>
                        </div>
                        <div class="control-group"><label>Node Size:</label><input type="range" id="nodeSizePaperMesh" min="3" max="15" value="8"><span id="nodeSizeValuePM">8</span></div>
                        <div class="control-group"><label>Layout:</label><select id="layoutPaperMesh"><option value="force">Force-Directed</option><option value="circular">Circular</option></select></div>
                        <button class="btn btn-primary" onclick="resetZoom('paper-mesh')">Reset View</button>
                        <button class="btn btn-clear" onclick="clearSelection('paper-mesh')">Clear Selection</button>
                        <button class="btn btn-secondary" onclick="downloadNetwork('paper-mesh')">Download Excel</button>
                    </div>
                    <div class="svg-container"><svg id="svgPaperMesh" width="100%" height="100%"></svg></div>
                    <div class="legend">
                        <div class="legend-title">Legend</div>
                        <div class="legend-item"><div class="legend-color" style="background: #fcb045;"></div><span>Journals/Papers (hover to preview, click to select & view PubMed)</span></div>
                        <div class="legend-item"><div class="legend-color" style="background: #833ab4;"></div><span>MeSH Terms</span></div>
                    </div>
                    <div class="stats" id="statsPaperMesh"></div>
                </div>
                <div id="coauthorship" class="network-container">
                    <div class="controls">
                        <div class="search-container">
                            <input type="text" class="search-input" id="searchCoauthorship" placeholder="üîç Search authors..." />
                            <span class="search-icon">üîç</span>
                            <div class="search-results" id="searchResultsCoauthorship"></div>
                        </div>
                        <div class="control-group"><label>Node Size:</label><input type="range" id="nodeSizeCoauthorship" min="3" max="15" value="8"><span id="nodeSizeValueCA">8</span></div>
                        <div class="control-group"><label>Layout:</label><select id="layoutCoauthorship"><option value="force">Force-Directed</option><option value="circular">Circular</option></select></div>
                        <div class="control-group"><label>Min Collaborations:</label><input type="range" id="minWeight" min="1" max="10" value="1"><span id="minWeightValue">1</span></div>
                        <button class="btn btn-primary" onclick="resetZoom('coauthorship')">Reset View</button>
                        <button class="btn btn-clear" onclick="clearSelection('coauthorship')">Clear Selection</button>
                        <button class="btn btn-secondary" onclick="downloadNetwork('coauthorship')">Download Excel</button>
                    </div>
                    <div class="svg-container"><svg id="svgCoauthorship" width="100%" height="100%"></svg></div>
                    <div class="legend"><div class="legend-title">Community Detection</div><div id="communityLegend"></div></div>
                    <div class="stats" id="statsCoauthorship"></div>
                </div>
            </div>
        </div>
        <div class="tooltip" id="tooltip"></div>
        <footer><p>Interactive network visualization ‚Ä¢ Hover to preview ‚Ä¢ Click to lock selection ‚Ä¢ Drag & zoom while selected ‚Ä¢ Click "Clear Selection" to reset</p></footer>
    </div>
    <script>
let paperMeshNetwork=null,coauthorshipNetwork=null,paperMeshSimulation=null,coauthorshipSimulation=null,currentNodeSize={'paper-mesh':8,'coauthorship':8};let selectedNode={'paper-mesh':null,'coauthorship':null};const journalColor='#fcb045';const meshColor='#833ab4';const communityColors=['#833ab4','#fd1d1d','#fcb045','#1a2a6c','#b21f1f','#fdbb2d','#cac531','#7f7fd5','#86a8e7','#74ebd5','#0082c8'];document.getElementById('fileInput').addEventListener('change',e=>{const file=e.target.files[0];if(file)processFile(file);});const uploadSection=document.getElementById('uploadSection');uploadSection.addEventListener('dragover',e=>{e.preventDefault();uploadSection.classList.add('dragover');});uploadSection.addEventListener('dragleave',()=>uploadSection.classList.remove('dragover'));uploadSection.addEventListener('drop',e=>{e.preventDefault();uploadSection.classList.remove('dragover');if(e.dataTransfer.files[0])processFile(e.dataTransfer.files[0]);});function processFile(file){document.getElementById('loading').classList.add('active');document.getElementById('errorMsg').classList.remove('active');const reader=new FileReader();reader.onload=e=>{try{const papers=parsePubMedData(e.target.result);paperMeshNetwork=generatePaperMeshNetwork(papers);coauthorshipNetwork=generateCoauthorshipNetwork(papers);displayNetworks();document.getElementById('loading').classList.remove('active');document.getElementById('uploadSection').style.display='none';document.getElementById('networkSection').style.display='block';setupSearch();}catch(error){document.getElementById('errorMsg').textContent='Error: '+error.message;document.getElementById('errorMsg').classList.add('active');document.getElementById('loading').classList.remove('active');}};reader.readAsText(file);}function parsePubMedData(data){const papers=[];const entries=data.split('PMID-');for(let i=1;i<entries.length;i++){const entry=entries[i].trim();const lines=entry.split('\n');const paper={journal:'',authors:[],meshTerms:[],pmid:''};const pmidMatch=entry.match(/^(\d+)/);if(pmidMatch){paper.pmid=pmidMatch[1];}for(const line of lines){if(line.startsWith('JT  -'))paper.journal=line.replace('JT  -','').trim();else if(line.startsWith('FAU -')){const name=line.replace('FAU -','').trim();if(name.includes(',')){const[last,first]=name.split(',',2);const firstName=first.trim().split(' ')[0]||'';paper.authors.push(firstName?`${firstName} ${last.trim()}`:last.trim());}else paper.authors.push(name);}else if(line.startsWith('MH  -'))paper.meshTerms.push(line.replace('MH  -','').trim().replace('*',''));}if(paper.journal&&paper.pmid&&(paper.authors.length>0||paper.meshTerms.length>0)){papers.push(paper);}}return papers;}function generatePaperMeshNetwork(papers){const nodes=[],links=[],nodeMap=new Map();let nodeId=0;papers.forEach(paper=>{const journalLabel=`${paper.journal} [PMID:${paper.pmid}]`;if(!nodeMap.has(journalLabel)){nodeMap.set(journalLabel,nodeId);nodes.push({id:nodeId++,name:journalLabel,displayName:journalLabel,type:'journal',degree:0,pmid:paper.pmid});}paper.meshTerms.forEach(mesh=>{if(!nodeMap.has(mesh)){nodeMap.set(mesh,nodeId);nodes.push({id:nodeId++,name:mesh,displayName:mesh,type:'mesh',degree:0});}const jId=nodeMap.get(journalLabel),mId=nodeMap.get(mesh);links.push({source:jId,target:mId});nodes[jId].degree++;nodes[mId].degree++;});});return{nodes,links};}function generateCoauthorshipNetwork(papers){const nodes=[],links=[],nodeMap=new Map(),collaborations=new Map();let nodeId=0;papers.forEach(paper=>{if(paper.authors.length<2)return;paper.authors.forEach(author=>{if(!nodeMap.has(author)){nodeMap.set(author,nodeId);nodes.push({id:nodeId++,name:author,displayName:author,degree:0,papers:0});}nodes[nodeMap.get(author)].papers++;});for(let i=0;i<paper.authors.length;i++){for(let j=i+1;j<paper.authors.length;j++){const pair=[paper.authors[i],paper.authors[j]].sort().join('|');if(!collaborations.has(pair)){collaborations.set(pair,{source:nodeMap.get(paper.authors[i]),target:nodeMap.get(paper.authors[j]),weight:0});}collaborations.get(pair).weight++;}}});collaborations.forEach(c=>{links.push(c);nodes[c.source].degree++;nodes[c.target].degree++;});detectCommunities(nodes,links);return{nodes,links};}function detectCommunities(nodes,links){const communities=new Map();nodes.forEach((n,i)=>communities.set(n.id,i));const adj=new Map();nodes.forEach(n=>adj.set(n.id,[]));links.forEach(l=>{const sId=typeof l.source==='object'?l.source.id:l.source;const tId=typeof l.target==='object'?l.target.id:l.target;adj.get(sId).push({node:tId,weight:l.weight});adj.get(tId).push({node:sId,weight:l.weight});});for(let iter=0;iter<10;iter++){let improved=false;nodes.forEach(node=>{const curr=communities.get(node.id);const neighbors=new Map();adj.get(node.id).forEach(n=>{const c=communities.get(n.node);neighbors.set(c,(neighbors.get(c)||0)+n.weight);});let best=curr,bestScore=neighbors.get(curr)||0;neighbors.forEach((score,comm)=>{if(score>bestScore){bestScore=score;best=comm;}});if(best!==curr){communities.set(node.id,best);improved=true;}});if(!improved)break;}const unique=[...new Set(communities.values())];const map=new Map();unique.forEach((c,i)=>map.set(c,i));nodes.forEach(n=>n.community=map.get(communities.get(n.id)));}function highlightNode(nodeId,networkType){const svg=networkType==='paper-mesh'?d3.select('#svgPaperMesh'):d3.select('#svgCoauthorship');const data=networkType==='paper-mesh'?paperMeshNetwork:coauthorshipNetwork;const connectedNodeIds=new Set([nodeId]);const connectedLinkIds=new Set();data.links.forEach((link,idx)=>{const sourceId=link.source.id!==undefined?link.source.id:link.source;const targetId=link.target.id!==undefined?link.target.id:link.target;if(sourceId===nodeId||targetId===nodeId){connectedNodeIds.add(sourceId);connectedNodeIds.add(targetId);connectedLinkIds.add(idx);}});svg.selectAll('.node').classed('faded',d=>!connectedNodeIds.has(d.id)).classed('highlighted',d=>d.id===nodeId);svg.selectAll('.link').each(function(d,i){d3.select(this).classed('faded',!connectedLinkIds.has(i)).classed('highlighted',connectedLinkIds.has(i));});svg.selectAll('text').classed('faded',d=>!connectedNodeIds.has(d.id)).classed('highlighted',d=>d.id===nodeId);}function clearHighlight(networkType){const svg=networkType==='paper-mesh'?d3.select('#svgPaperMesh'):d3.select('#svgCoauthorship');svg.selectAll('.node').classed('faded',false).classed('highlighted',false);svg.selectAll('.link').classed('faded',false).classed('highlighted',false);svg.selectAll('text').classed('faded',false).classed('highlighted',false);}function clearSelection(networkType){selectedNode[networkType]=null;clearHighlight(networkType);}function focusOnNode(nodeId,networkType){const data=networkType==='paper-mesh'?paperMeshNetwork:coauthorshipNetwork;const node=data.nodes.find(n=>n.id===nodeId);if(!node)return;const svg=networkType==='paper-mesh'?d3.select('#svgPaperMesh'):d3.select('#svgCoauthorship');const container=svg.node().parentElement;const width=container.clientWidth;const height=container.clientHeight;const scale=1.5;const x=width/2-node.x*scale;const y=height/2-node.y*scale;svg.transition().duration(750).call(d3.zoom().transform,d3.zoomIdentity.translate(x,y).scale(scale));selectedNode[networkType]=nodeId;highlightNode(nodeId,networkType);}function setupSearch(){const searchPM=document.getElementById('searchPaperMesh');const searchCA=document.getElementById('searchCoauthorship');const resultsPM=document.getElementById('searchResultsPaperMesh');const resultsCA=document.getElementById('searchResultsCoauthorship');searchPM.addEventListener('input',e=>performSearch(e.target.value,'paper-mesh',resultsPM));searchCA.addEventListener('input',e=>performSearch(e.target.value,'coauthorship',resultsCA));document.addEventListener('click',e=>{if(!e.target.closest('.search-container')){resultsPM.classList.remove('show');resultsCA.classList.remove('show');}});}function performSearch(query,networkType,resultsDiv){if(!query.trim()){resultsDiv.classList.remove('show');return;}const data=networkType==='paper-mesh'?paperMeshNetwork:coauthorshipNetwork;const matches=data.nodes.filter(n=>n.displayName.toLowerCase().includes(query.toLowerCase())).slice(0,10);if(matches.length===0){resultsDiv.innerHTML='<div class="no-results">No matches found</div>';resultsDiv.classList.add('show');return;}resultsDiv.innerHTML=matches.map(node=>`<div class="search-result-item" onclick="selectSearchResult(${node.id},'${networkType}')">${node.displayName}</div>`).join('');resultsDiv.classList.add('show');}function selectSearchResult(nodeId,networkType){focusOnNode(nodeId,networkType);const resultsDiv=networkType==='paper-mesh'?document.getElementById('searchResultsPaperMesh'):document.getElementById('searchResultsCoauthorship');resultsDiv.classList.remove('show');const searchInput=networkType==='paper-mesh'?document.getElementById('searchPaperMesh'):document.getElementById('searchCoauthorship');searchInput.value='';}function displayNetworks(){displayPaperMeshNetwork();displayCoauthorshipNetwork();updateStats();}function displayPaperMeshNetwork(){const svg=d3.select('#svgPaperMesh');svg.selectAll('*').remove();const container=svg.node().parentElement;const width=container.clientWidth,height=container.clientHeight;const g=svg.append('g');const simulation=d3.forceSimulation(paperMeshNetwork.nodes).force('link',d3.forceLink(paperMeshNetwork.links).id(d=>d.id).distance(100)).force('charge',d3.forceManyBody().strength(-300)).force('center',d3.forceCenter(width/2,height/2)).force('collision',d3.forceCollide().radius(30));const link=g.append('g').selectAll('line').data(paperMeshNetwork.links).join('line').attr('class','link').attr('stroke-width',1.5);const node=g.append('g').selectAll('circle').data(paperMeshNetwork.nodes).join('circle').attr('class','node').attr('r',d=>Math.sqrt(d.degree)*currentNodeSize['paper-mesh']+8).attr('fill',d=>d.type==='journal'?journalColor:meshColor).call(d3.drag().on('start',e=>{if(!e.active)simulation.alphaTarget(0.3).restart();e.subject.fx=e.subject.x;e.subject.fy=e.subject.y;}).on('drag',e=>{e.subject.fx=e.x;e.subject.fy=e.y;}).on('end',e=>{if(!e.active)simulation.alphaTarget(0);e.subject.fx=null;e.subject.fy=null;})).on('mouseenter',(e,d)=>{if(selectedNode['paper-mesh']===null){highlightNode(d.id,'paper-mesh');}let html=`<strong>${d.displayName}</strong><br/>Type: ${d.type==='journal'?'Journal':'MeSH'}<br/>Connections: ${d.degree}`;if(d.type==='journal'&&d.pmid){html+=`<br/><br/><strong>Click to select & view on PubMed</strong>`;}document.getElementById('tooltip').innerHTML=html;document.getElementById('tooltip').style.left=(e.pageX+10)+'px';document.getElementById('tooltip').style.top=(e.pageY-10)+'px';document.getElementById('tooltip').classList.add('show');}).on('mouseleave',()=>{if(selectedNode['paper-mesh']===null){clearHighlight('paper-mesh');}document.getElementById('tooltip').classList.remove('show');}).on('click',(e,d)=>{e.stopPropagation();selectedNode['paper-mesh']=d.id;highlightNode(d.id,'paper-mesh');if(d.type==='journal'&&d.pmid){window.open(`https://pubmed.ncbi.nlm.nih.gov/${d.pmid}/`,'_blank');}});const label=g.append('g').selectAll('text').data(paperMeshNetwork.nodes).join('text').text(d=>{if(d.displayName.length>50){return d.displayName.substring(0,50)+'...';}return d.displayName;}).attr('font-size',d=>Math.max(8,Math.sqrt(d.degree)*currentNodeSize['paper-mesh']/2+6)).attr('fill','#1e293b').attr('font-weight','500');simulation.on('tick',()=>{link.attr('x1',d=>d.source.x).attr('y1',d=>d.source.y).attr('x2',d=>d.target.x).attr('y2',d=>d.target.y);node.attr('cx',d=>d.x).attr('cy',d=>d.y);label.attr('x',d=>d.x).attr('y',d=>d.y);});svg.call(d3.zoom().scaleExtent([0.1,4]).on('zoom',e=>g.attr('transform',e.transform)));svg.on('click',function(e){if(e.target===this){clearSelection('paper-mesh');}});paperMeshSimulation=simulation;}function displayCoauthorshipNetwork(){const svg=d3.select('#svgCoauthorship');svg.selectAll('*').remove();const container=svg.node().parentElement;const width=container.clientWidth,height=container.clientHeight;const g=svg.append('g');const simulation=d3.forceSimulation(coauthorshipNetwork.nodes).force('link',d3.forceLink(coauthorshipNetwork.links).id(d=>d.id).distance(d=>120/Math.sqrt(d.weight))).force('charge',d3.forceManyBody().strength(-400)).force('center',d3.forceCenter(width/2,height/2)).force('collision',d3.forceCollide().radius(35));const link=g.append('g').selectAll('line').data(coauthorshipNetwork.links).join('line').attr('class','link').attr('stroke-width',d=>Math.sqrt(d.weight)*2);const node=g.append('g').selectAll('circle').data(coauthorshipNetwork.nodes).join('circle').attr('class','node').attr('r',d=>Math.sqrt(d.degree)*currentNodeSize['coauthorship']+10).attr('fill',d=>communityColors[d.community%communityColors.length]).call(d3.drag().on('start',e=>{if(!e.active)simulation.alphaTarget(0.3).restart();e.subject.fx=e.subject.x;e.subject.fy=e.subject.y;}).on('drag',e=>{e.subject.fx=e.x;e.subject.fy=e.y;}).on('end',e=>{if(!e.active)simulation.alphaTarget(0);e.subject.fx=null;e.subject.fy=null;})).on('mouseenter',(e,d)=>{if(selectedNode['coauthorship']===null){highlightNode(d.id,'coauthorship');}const searchName=d.name.replace(/ /g,'+');const html=`<strong>${d.displayName}</strong><br/>Community: ${d.community+1}<br/>Collaborations: ${d.degree}<br/>Papers: ${d.papers}<br/><br/><strong>Click to select & search on PubMed</strong>`;document.getElementById('tooltip').innerHTML=html;document.getElementById('tooltip').style.left=(e.pageX+10)+'px';document.getElementById('tooltip').style.top=(e.pageY-10)+'px';document.getElementById('tooltip').classList.add('show');}).on('mouseleave',()=>{if(selectedNode['coauthorship']===null){clearHighlight('coauthorship');}document.getElementById('tooltip').classList.remove('show');}).on('click',(e,d)=>{e.stopPropagation();selectedNode['coauthorship']=d.id;highlightNode(d.id,'coauthorship');const searchName=d.name.replace(/ /g,'+');window.open(`https://pubmed.ncbi.nlm.nih.gov/?term=${searchName}`,'_blank');});const label=g.append('g').selectAll('text').data(coauthorshipNetwork.nodes).join('text').text(d=>d.displayName).attr('font-size',d=>Math.max(8,Math.sqrt(d.degree)*currentNodeSize['coauthorship']/1.5+7)).attr('fill','#1e293b').attr('font-weight','600');simulation.on('tick',()=>{link.attr('x1',d=>d.source.x).attr('y1',d=>d.source.y).attr('x2',d=>d.target.x).attr('y2',d=>d.target.y);node.attr('cx',d=>d.x).attr('cy',d=>d.y);label.attr('x',d=>d.x).attr('y',d=>d.y);});svg.call(d3.zoom().scaleExtent([0.1,4]).on('zoom',e=>g.attr('transform',e.transform)));svg.on('click',function(e){if(e.target===this){clearSelection('coauthorship');}});coauthorshipSimulation=simulation;const communities=[...new Set(coauthorshipNetwork.nodes.map(n=>n.community))].sort();document.getElementById('communityLegend').innerHTML=communities.map(c=>{const count=coauthorshipNetwork.nodes.filter(n=>n.community===c).length;const color=communityColors[c%communityColors.length];return`<div class="legend-item"><div class="legend-color" style="background: ${color};"></div><span>Community ${c+1} (${count} authors)</span></div>`;}).join('');}function updateStats(){const journals=paperMeshNetwork.nodes.filter(n=>n.type==='journal').length;const meshTerms=paperMeshNetwork.nodes.filter(n=>n.type==='mesh').length;document.getElementById('statsPaperMesh').innerHTML=`<div class="stat-card"><div class="stat-value">${journals}</div><div class="stat-label">Journals</div></div><div class="stat-card"><div class="stat-value">${meshTerms}</div><div class="stat-label">MeSH Terms</div></div><div class="stat-card"><div class="stat-value">${paperMeshNetwork.links.length}</div><div class="stat-label">Connections</div></div>`;const numCommunities=new Set(coauthorshipNetwork.nodes.map(n=>n.community)).size;document.getElementById('statsCoauthorship').innerHTML=`<div class="stat-card"><div class="stat-value">${coauthorshipNetwork.nodes.length}</div><div class="stat-label">Authors</div></div><div class="stat-card"><div class="stat-value">${coauthorshipNetwork.links.length}</div><div class="stat-label">Collaborations</div></div><div class="stat-card"><div class="stat-value">${numCommunities}</div><div class="stat-label">Communities</div></div>`;}function switchNetwork(networkType){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));event.target.classList.add('active');document.querySelectorAll('.network-container').forEach(c=>c.classList.remove('active'));document.getElementById(networkType).classList.add('active');}function resetZoom(networkType){const svg=networkType==='paper-mesh'?d3.select('#svgPaperMesh'):d3.select('#svgCoauthorship');svg.transition().duration(750).call(d3.zoom().transform,d3.zoomIdentity.translate(0,0).scale(1));if(networkType==='paper-mesh')paperMeshSimulation.alpha(1).restart();else coauthorshipSimulation.alpha(1).restart();}function downloadNetwork(networkType){try{if(typeof XLSX==='undefined'){alert('Excel library not loaded');return;}const data=networkType==='paper-mesh'?paperMeshNetwork:coauthorshipNetwork;const rows=networkType==='paper-mesh'?[['Source','Target','Type','Source Type','Target Type','PMID']]:[['Source','Target','Weight','Source Community','Target Community']];data.links.forEach(link=>{const sId=link.source.id!==undefined?link.source.id:link.source;const tId=link.target.id!==undefined?link.target.id:link.target;const s=data.nodes.find(n=>n.id===sId);const t=data.nodes.find(n=>n.id===tId);if(s&&t){if(networkType==='paper-mesh')rows.push([s.name,t.name,'Undirected',s.type==='journal'?'Journal':'MeSH',t.type==='journal'?'Journal':'MeSH',s.pmid||'']);else rows.push([s.name,t.name,link.weight,s.community+1,t.community+1]);}});const wb=XLSX.utils.book_new();const ws=XLSX.utils.aoa_to_sheet(rows);XLSX.utils.book_append_sheet(wb,ws,networkType==='paper-mesh'?'Paper-MeSH':'Coauthorship');XLSX.writeFile(wb,`${networkType}_network_${new Date().toISOString().split('T')[0]}.xlsx`);}catch(error){alert('Download error: '+error.message);}}document.getElementById('nodeSizePaperMesh').addEventListener('input',e=>{currentNodeSize['paper-mesh']=parseFloat(e.target.value);document.getElementById('nodeSizeValuePM').textContent=e.target.value;displayPaperMeshNetwork();});document.getElementById('nodeSizeCoauthorship').addEventListener('input',e=>{currentNodeSize['coauthorship']=parseFloat(e.target.value);document.getElementById('nodeSizeValueCA').textContent=e.target.value;displayCoauthorshipNetwork();});document.getElementById('layoutPaperMesh').addEventListener('change',e=>{if(e.target.value==='circular'){const nodes=paperMeshNetwork.nodes;const radius=250,angleStep=(2*Math.PI)/nodes.length;nodes.forEach((n,i)=>{const angle=i*angleStep;n.fx=300+radius*Math.cos(angle);n.fy=300+radius*Math.sin(angle);});paperMeshSimulation.alpha(0.3).restart();setTimeout(()=>nodes.forEach(n=>{n.fx=null;n.fy=null;}),2000);}else displayPaperMeshNetwork();});document.getElementById('layoutCoauthorship').addEventListener('change',e=>{if(e.target.value==='circular'){const nodes=coauthorshipNetwork.nodes;const radius=250,angleStep=(2*Math.PI)/nodes.length;nodes.forEach((n,i)=>{const angle=i*angleStep;n.fx=300+radius*Math.cos(angle);n.fy=300+radius*Math.sin(angle);});coauthorshipSimulation.alpha(0.3).restart();setTimeout(()=>nodes.forEach(n=>{n.fx=null;n.fy=null;}),2000);}else displayCoauthorshipNetwork();});document.getElementById('minWeight').addEventListener('input',e=>{document.getElementById('minWeightValue').textContent=e.target.value;const minW=parseInt(e.target.value);const filteredLinks=coauthorshipNetwork.links.filter(l=>l.weight>=minW);const connectedIds=new Set();filteredLinks.forEach(l=>{connectedIds.add(l.source.id||l.source);connectedIds.add(l.target.id||l.target);});const filteredNodes=coauthorshipNetwork.nodes.filter(n=>connectedIds.has(n.id));const temp=coauthorshipNetwork;coauthorshipNetwork={nodes:filteredNodes,links:filteredLinks};displayCoauthorshipNetwork();coauthorshipNetwork=temp;});
    </script>
</body>
</html>
